<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…±äº«å‡ºè¡Œå¹³å°</title>

    <style>
        /* ========== å…¨å±€æ ·å¼ & CSSå˜é‡ ========== */
        :root {
            --primary-color: #4A90E2;
            --primary-dark: #357ABD;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --danger-color: #f5222d;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c7d;
            --bg-light: #f5f7fa;
            --bg-white: #ffffff;
            --shadow-light: 0 2px 12px rgba(0,0,0,0.08);
            --shadow-medium: 0 4px 20px rgba(0,0,0,0.12);
            --shadow-heavy: 0 8px 32px rgba(0,0,0,0.16);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: var(--bg-light);
            overflow-x: hidden;
            color: var(--text-primary);
        }

        /* ========== é¡µé¢å®¹å™¨ ========== */
        .page {
            display: none;
            min-height: 100vh;
            background: var(--bg-white);
            animation: fadeIn 0.4s ease-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== é¡¶éƒ¨å¯¼èˆªæ  ========== */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: var(--shadow-light);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .navbar .back-btn {
            position: absolute;
            left: 12px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            transition: var(--transition);
        }

        .navbar .back-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        /* ========== åº•éƒ¨å¯¼èˆª ========== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: rgba(255,255,255,0.95);
            border-top: 1px solid rgba(0,0,0,0.05);
            display: flex;
            z-index: 1000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .bottom-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .bottom-nav-item.active {
            color: var(--primary-color);
            transform: translateY(-4px);
        }

        .bottom-nav-item .icon {
            font-size: 22px;
            margin-bottom: 2px;
            transition: var(--transition);
        }

        .bottom-nav-item.active .icon {
            transform: scale(1.15);
        }

        /* ========== ç™»å½•é¡µ ========== */
        .login-page {
            background: linear-gradient(135deg, #6a93cb 0%, #a4bfef 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
            position: relative;
        }

        .login-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGZpbGw9IiNGRkYiIGZpbGwtb3BhY2l0eT0iMC4wNSIgZD0iTTAgMGg0MDB2NDAwSDB6Ii8+PGNpcmNsZSBmaWxsPSIjRkZGIiBmaWxsLW9wYWNpdHk9IjAuMSIgY3g9IjcwIiBjeT0iNzAiIHI9IjQwIi8+PGNpcmNsZSBmaWxsPSIjRkZGIiBmaWxsLW9wYWNpdHk9IjAuMSIgY3g9IjMzMCIgY3k9IjMwMCIgcj0iNjAiLz48Y2lyY2xlIGZpbGw9IiNGRkYiIGZpbGwtb3BhY2l0eT0iMC4wOCIgY3g9IjMwMCIgY3k9IjEwMCIgcj0iMzUiLz48L2c+PC9zdmc+');
            opacity: 0.3;
            z-index: 0;
        }

        .login-content {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 340px;
        }

        .login-logo {
            font-size: 64px;
            color: white;
            margin-bottom: 16px;
            text-align: center;
            text-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .login-title {
            font-size: 28px;
            color: white;
            margin-bottom: 40px;
            font-weight: 600;
            text-align: center;
            letter-spacing: 1px;
        }

        .login-form {
            background: rgba(255,255,255,0.95);
            padding: 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .input-group {
            margin-bottom: 20px;
            position: relative;
        }

        .input-group input {
            width: 100%;
            height: 48px;
            padding: 0 16px;
            border: 1px solid #e1e8ed;
            border-radius: 24px;
            font-size: 15px;
            background: white;
            transition: var(--transition);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .btn-primary {
            width: 100%;
            height: 48px;
            border: none;
            border-radius: 24px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
            margin-top: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            width: 100%;
            height: 48px;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 24px;
            background: rgba(255,255,255,0.15);
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 16px;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.8);
        }

        .btn-code {
            width: 100%;
            height: 44px;
            border: 1px solid var(--primary-color);
            border-radius: 22px;
            background: white;
            color: var(--primary-color);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 12px;
            transition: var(--transition);
        }

        .btn-code:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
        }

        .btn-code:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f5f5f5;
            border-color: #ddd;
            color: #999;
        }

        /* ========== åœ°å›¾é¦–é¡µ========== */
        .map-leaflet {
            position: relative;
            height: 100vh;
            background: #e8eaed;
        }

        .map-view {
            width: 100%;
            height: calc(100% - 56px);
            position: relative;
            overflow: hidden;
        }
        .map-container {
            position: relative;
            height: calc(100vh - 56px);
            z-index: 1;
        }
        #leaflet-map {
            width: 100%;
            height: 100%;
        }

        .location-btn {
            position: absolute;
            bottom: 80px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-medium);
            cursor: pointer;
            z-index: 100;
            transition: var(--transition);
        }

        .location-btn:hover {
            transform: scale(1.1);
        }

        .scan-btn {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            box-shadow: var(--shadow-heavy);
            cursor: pointer;
            z-index: 1000;
            transition: var(--transition);
        }

        .scan-btn:hover {
            transform: translateX(-50%) scale(1.05);
        }

        .scan-btn:active {
            transform: translateX(-50%) scale(0.95);
        }

        /* ========== å®åè®¤è¯é¡µ ========== */
        .auth-page {
            background: var(--bg-light);
            padding: 60px 20px 20px;
        }

        .auth-steps {
            display: flex;
            justify-content: space-between;
            margin: 40px 20px;
            padding: 0 20px;
        }

        .auth-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .auth-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }

        .auth-step.active::after {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-weight: 600;
            position: relative;
            z-index: 1;
            transition: var(--transition);
        }

        .auth-step.active .step-number {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .auth-step div:last-child {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .auth-step.active div:last-child {
            color: var(--primary-color);
            font-weight: 500;
        }

        .auth-form {
            background: white;
            margin: 0 20px;
            padding: 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
        }

        .id-card-uploader {
            border: 2px dashed #d0d7e3;
            border-radius: var(--border-radius);
            padding: 48px 20px;
            text-align: center;
            margin-bottom: 32px;
            cursor: pointer;
            transition: var(--transition);
            background: #fafbfc;
        }

        .id-card-uploader:hover {
            border-color: var(--primary-color);
            background: rgba(74, 144, 226, 0.05);
        }

        /* ========== éª‘è¡Œä¸­é¡µé¢ ========== */
        .riding-page {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 80px 20px 40px;
            min-height: 100vh;
        }

        .riding-status {
            color: white;
            font-size: 28px;
            margin-bottom: 20px;
            font-weight: 500;
            letter-spacing: 1px;
        }

        .riding-time {
            color: white;
            font-size: 56px;
            font-weight: 300;
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
        }

        .riding-fee {
            color: rgba(255,255,255,0.9);
            font-size: 40px;
            margin-bottom: 60px;
            font-weight: 500;
        }

        .riding-actions {
            display: flex;
            gap: 32px;
            margin-bottom: 40px;
        }

        .riding-btn {
            width: 88px;
            height: 88px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.15);
            color: white;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .riding-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-4px);
        }

        .riding-btn.danger {
            border-color: rgba(255,107,107,0.5);
            background: rgba(255,107,107,0.15);
        }

        .riding-btn.danger:hover {
            background: rgba(255,107,107,0.3);
            transform: translateY(-4px) scale(1.05);
        }

        /* ========== ä¸ªäººä¸­å¿ƒ ========== */
        .profile-page {
            padding: 60px 20px 80px;
            background: var(--bg-light);
        }

        .profile-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            padding: 40px 20px;
            text-align: center;
            color: white;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            box-shadow: var(--shadow-light);
        }

        .profile-avatar {
            width: 88px;
            height: 88px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: var(--primary-color);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: var(--transition);
        }

        .profile-avatar:hover {
            transform: scale(1.05);
        }

        .credit-score {
            display: inline-block;
            padding: 6px 18px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            margin-top: 12px;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(5px);
        }

        .menu-list {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 18px 24px;
            border-bottom: 1px solid #f5f7fa;
            cursor: pointer;
            transition: var(--transition);
        }

        .menu-item:hover {
            background: #f8fafd;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-icon {
            width: 24px;
            height: 24px;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .menu-text {
            flex: 1;
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .menu-arrow {
            color: #bdc3c7;
            font-size: 18px;
        }

        /* ========== æ‰«ææ¨¡æ€æ¡† ========== */
        .scan-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.92);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .scan-modal.active {
            display: flex;
        }

        .scan-frame {
            width: 280px;
            height: 280px;
            border: 2px solid var(--primary-color);
            border-radius: 16px;
            position: relative;
            box-shadow: 0 0 40px rgba(74, 144, 226, 0.3);
        }

        .scan-frame::before,
        .scan-frame::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border: 4px solid var(--primary-color);
        }

        .scan-frame::before {
            top: -4px;
            left: -4px;
            border-right: none;
            border-bottom: none;
        }

        .scan-frame::after {
            bottom: -4px;
            right: -4px;
            border-left: none;
            border-top: none;
        }

        .scan-tip {
            position: absolute;
            bottom: 120px;
            color: white;
            font-size: 15px;
            text-align: center;
            font-weight: 500;
        }

        .close-scan {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 44px;
            height: 44px;
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-scan:hover {
            background: rgba(255,255,255,0.1);
        }

        /* ========== åŠ è½½åŠ¨ç”» ========== */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3000;
        }

        .loading.active {
            display: block;
        }

        .loading-spinner {
            width: 56px;
            height: 56px;
            border: 4px solid rgba(74, 144, 226, 0.2);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========== æç¤ºæ¶ˆæ¯ ========== */
        .toast {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 14px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            z-index: 4000;
            opacity: 0;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .toast.show {
            opacity: 1;
        }

        /* ========== åœ°å›¾è‡ªå®šä¹‰æ ·å¼è¦†ç›– ========== */
        .leaflet-control-container {
            display: none; /* éšè—é»˜è®¤æ§ä»¶ */
        }

        .custom-marker {
            background: white;
            border-radius: 50%;
            box-shadow: var(--shadow-medium);
            border: 3px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .custom-marker:hover {
            transform: scale(1.15);
            z-index: 1000;
        }

        .custom-marker.bicycle {
            background: var(--success-color);
        }

        .custom-marker.ebike {
            background: var(--warning-color);
        }

        .custom-marker.car {
            background: var(--danger-color);
        }

        /* ========== å“åº”å¼è®¾è®¡ ========== */
        @media (max-width: 375px) {
            .login-form {
                padding: 24px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<!-- ==================== SVGå›¾æ ‡åº“ ==================== -->
<svg style="display: none;">
    <!-- è‡ªè¡Œè½¦å›¾æ ‡ -->
    <symbol id="icon-bike" viewBox="0 0 24 24">
        <path fill="currentColor" d="M5,20.5A3.5,3.5 0 0,1 1.5,17A3.5,3.5 0 0,1 5,13.5A3.5,3.5 0 0,1 8.5,17A3.5,3.5 0 0,1 5,20.5M5,12A5,5 0 0,0 0,17A5,5 0 0,0 5,22A5,5 0 0,0 10,17A5,5 0 0,0 5,12M14.8,10H19V8.2H15.8L13.86,4.93C13.57,4.43 13,4.1 12.4,4.1C11.93,4.1 11.5,4.29 11.2,4.6L7.5,8.29C7.19,8.6 7,9 7,9.5C7,10.13 7.33,10.66 7.85,10.97L11.2,13V18H13V11.5L10.75,9.85L13.07,7.5M19,20.5A3.5,3.5 0 0,1 15.5,17A3.5,3.5 0 0,1 19,13.5A3.5,3.5 0 0,1 22.5,17A3.5,3.5 0 0,1 19,20.5M19,12A5,5 0 0,0 14,17A5,5 0 0,0 19,22A5,5 0 0,0 24,17A5,5 0 0,0 19,12M16,4.8C17,4.8 17.8,4 17.8,3C17.8,2 17,1.2 16,1.2C15,1.2 14.2,2 14.2,3C14.2,4 15,4.8 16,4.8Z"/>
    </symbol>

    <!-- ç”µåŠ¨è½¦å›¾æ ‡ -->
    <symbol id="icon-ebike" viewBox="0 0 24 24">
        <path fill="currentColor" d="M19,7V4H5V7H19M8,9A3,3 0 0,0 5,12A3,3 0 0,0 8,15A3,3 0 0,0 11,12A3,3 0 0,0 8,9M16,9A3,3 0 0,0 13,12A3,3 0 0,0 16,15A3,3 0 0,0 19,12A3,3 0 0,0 16,9M8,17A5,5 0 0,0 3,22A5,5 0 0,0 8,27A5,5 0 0,0 13,22A5,5 0 0,0 8,17M16,17A5,5 0 0,0 11,22A5,5 0 0,0 16,27A5,5 0 0,0 21,22A5,5 0 0,0 16,17M8,2A2,2 0 0,0 6,4A2,2 0 0,0 8,6A2,2 0 0,0 10,4A2,2 0 0,0 8,2M16,2A2,2 0 0,0 14,4A2,2 0 0,0 16,6A2,2 0 0,0 18,4A2,2 0 0,0 16,2M9,4H15V7H9V4M3,5H5V20H3V5M19,9V14H5V9H19Z"/>
    </symbol>

    <!-- æ±½è½¦å›¾æ ‡ -->
    <symbol id="icon-car" viewBox="0 0 24 24">
        <path fill="currentColor" d="M5,11L6.5,6.5H17.5L19,11M17.5,16A1.5,1.5 0 0,1 16,14.5A1.5,1.5 0 0,1 17.5,13A1.5,1.5 0 0,1 19,14.5A1.5,1.5 0 0,1 17.5,16M6.5,16A1.5,1.5 0 0,1 5,14.5A1.5,1.5 0 0,1 6.5,13A1.5,1.5 0 0,1 8,14.5A1.5,1.5 0 0,1 6.5,16M18.92,6C18.72,5.42 18.16,5 17.5,5H6.5C5.84,5 5.28,5.42 5.08,6L3,12V20A1,1 0 0,0 4,21H5A1,1 0 0,0 6,20V19H18V20A1,1 0 0,0 19,21H20A1,1 0 0,0 21,20V12L18.92,6M17.85,12.5C17.85,12.77 17.62,13 17.35,13H6.5C6.23,13 6,12.77 6,12.5V7.5H17.85V12.5Z"/>
    </symbol>

    <!-- å®šä½å›¾æ ‡ -->
    <symbol id="icon-location" viewBox="0 0 24 24">
        <path fill="currentColor" d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22S19,14.25 19,9A7,7 0 0,0 12,2Z"/>
    </symbol>

    <!-- ç›¸æœºå›¾æ ‡ -->
    <symbol id="icon-camera" viewBox="0 0 24 24">
        <path fill="currentColor" d="M12,15.5A3.5,3.5 0 0,0 15.5,12A3.5,3.5 0 0,0 12,8.5A3.5,3.5 0 0,0 8.5,12A3.5,3.5 0 0,0 12,15.5M9,2L7.17,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4H16.83L15,2H9Z"/>
    </symbol>
</svg>

<!-- ==================== é¡µé¢å®¹å™¨ ==================== -->
<div id="app">
    <!-- ç™»å½•é¡µ -->
    <div class="page login-page" id="loginPage">
        <div class="login-content">
            <div class="login-logo">ğŸš²</div>
            <div class="login-title">å…±äº«å‡ºè¡Œ</div>
            <div class="login-form">
                <div class="input-group">
                    <input type="tel" id="phoneInput" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" maxlength="11">
                </div>
                <div class="input-group">
                    <input type="text" id="codeInput" placeholder="è¯·è¾“å…¥éªŒè¯ç ">
                </div>
                <button class="btn-code" id="getCodeBtn">è·å–éªŒè¯ç </button>
                <button class="btn-primary" onclick="login()">ç™»å½•/æ³¨å†Œ</button>
                <button class="btn-secondary" onclick="wechatLogin()">å¾®ä¿¡ä¸€é”®ç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- åœ°å›¾é¦–é¡µ  -->
    <!-- åœ°å›¾é¦–é¡µ -->
    <div class="page" id="mapPage">
        <div class="navbar">
            <div class="back-btn" onclick="goToProfile()">...</div>
            <div>å…±äº«å‡ºè¡Œ</div>
            <div class="menu-btn" onclick="goToProfile()">...</div>
        </div>

        <!-- åœ°å›¾å®¹å™¨ -->
        <div class="map-container">
            <div class="map-view" id="mapView">
                <div id="leaflet-map"></div>
            </div>
            <div class="location-btn" onclick="locateMe()">...</div>
            <div class="scan-btn" onclick="openScan()">...</div>
        </div>

        <!-- âœ… æ·»åŠ åº•éƒ¨å¯¼èˆªæ  -->
        <div class="bottom-nav">
            <div class="bottom-nav-item active" data-target="map">
                <div class="icon">ğŸ—ºï¸</div>
                <div>åœ°å›¾</div>
            </div>
            <div class="bottom-nav-item" data-target="profile">
                <div class="icon">ğŸ‘¤</div>
                <div>æˆ‘çš„</div>
            </div>
        </div>
    </div>

    <!-- å®åè®¤è¯é¡µ -->
    <div class="page auth-page" id="authPage">
        <div class="navbar">
            <div class="back-btn" onclick="backToMap()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                    <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"/>
                </svg>
            </div>
            <div>å®åè®¤è¯</div>
        </div>
        <div class="auth-steps">
            <div class="auth-step active">
                <div class="step-number">1</div>
                <div>èº«ä»½è¯</div>
            </div>
            <div class="auth-step">
                <div class="step-number">2</div>
                <div>æ´»ä½“æ£€æµ‹</div>
            </div>
            <div class="auth-step">
                <div class="step-number">3</div>
                <div>å®Œæˆ</div>
            </div>
        </div>
        <div class="auth-form">
            <div class="id-card-uploader" onclick="uploadIdCard()">
                <div style="font-size: 56px; margin-bottom: 12px; color: var(--primary-color);">ğŸ“·</div>
                <div style="color: var(--text-secondary); font-weight: 500;">ç‚¹å‡»æ‹æ‘„èº«ä»½è¯äººåƒé¢</div>
            </div>
            <button class="btn-primary" onclick="startFaceVerify()">å¼€å§‹äººè„¸è¯†åˆ«</button>
        </div>
    </div>

    <!-- éª‘è¡Œä¸­é¡µé¢ -->
    <div class="page riding-page" id="ridingPage">
        <div class="riding-status">éª‘è¡Œä¸­</div>
        <div class="riding-time" id="ridingTime">00:00</div>
        <div class="riding-fee" id="ridingFee">Â¥0.00</div>
        <div class="riding-actions">
            <div class="riding-btn" onclick="tempLock()">
                <div style="font-size: 24px; margin-bottom: 4px;">ğŸ”’</div>
                <div>ä¸´æ—¶é”è½¦</div>
            </div>
            <div class="riding-btn danger" onclick="finishRide()">
                <div style="font-size: 24px; margin-bottom: 4px;">ğŸ</div>
                <div>ç»“æŸéª‘è¡Œ</div>
            </div>
        </div>
    </div>

    <!-- ä¸ªäººä¸­å¿ƒ -->
    <div class="page profile-page" id="profilePage">
        <div class="navbar">
            <div class="back-btn" onclick="backToMap()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                    <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"/>
                </svg>
            </div>
            <div>ä¸ªäººä¸­å¿ƒ</div>
        </div>
        <div class="profile-header">
            <div class="profile-avatar">ğŸ‘¤</div>
            <div id="userName">ç”¨æˆ·138****5678</div>
            <div class="credit-score">ä¿¡ç”¨åˆ†: <span id="creditScore">600</span></div>
            <!-- æ–°å¢ï¼šæŠ¼é‡‘çŠ¶æ€ -->
            <div class="deposit-status" id="depositStatus" style="margin-top: 8px; font-size: 13px; opacity: 0.9;">
                æŠ¼é‡‘çŠ¶æ€: <span id="depositStatusText">æœªç¼´çº³</span>
            </div>
        </div>
        <div class="menu-list">
            <div class="menu-item" onclick="goToOrders()">
                <div class="menu-icon">ğŸ“‹</div>
                <div class="menu-text">æˆ‘çš„è¡Œç¨‹</div>
                <div class="menu-arrow">â€º</div>
            </div>
            <div class="menu-item" onclick="goToCoupons()">
                <div class="menu-icon">ğŸ«</div>
                <div class="menu-text">ä¼˜æƒ åˆ¸</div>
                <div class="menu-arrow">â€º</div>
            </div>
            <div class="menu-item" onclick="goToWallet()">
                <div class="menu-icon">ğŸ’°</div>
                <div class="menu-text">é’±åŒ…ä½™é¢</div>
                <div class="menu-arrow">â€º</div>
            </div>
            <div class="menu-item" onclick="goToCredit()">
                <div class="menu-icon">â­</div>
                <div class="menu-text">ä¿¡ç”¨åˆ†</div>
                <div class="menu-arrow">â€º</div>
            </div>
            <div class="menu-item" onclick="goToDeposit()">
                <div class="menu-icon">ğŸ’³</div>
                <div class="menu-text">æŠ¼é‡‘ç®¡ç†</div>
                <div class="menu-arrow">â€º</div>
            </div>
            <div class="menu-item" onclick="logout()">
                <div class="menu-icon">ğŸšª</div>
                <div class="menu-text">é€€å‡ºç™»å½•</div>
                <div class="menu-arrow">â€º</div>
            </div>
        </div>
    </div>

    <!-- äºŒç»´ç æ‰«ææ¨¡æ€æ¡† -->
    <div class="scan-modal" id="scanModal">
        <div class="close-scan" onclick="closeScan()">Ã—</div>
        <div class="scan-frame"></div>
        <div class="scan-tip">å°†äºŒç»´ç æ”¾å…¥æ¡†å†…ï¼Œå³å¯æ‰«æ</div>
    </div>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
    </div>

    <!-- æç¤ºæ¶ˆæ¯ -->
    <div class="toast" id="toast"></div>
</div>



<!-- ==================== æ‰€æœ‰JavaScriptä»£ç ï¼ˆç»Ÿä¸€åœ¨ä¸€ä¸ªå—ä¸­ï¼‰ ==================== -->
<script>
    // ==================== å…¨å±€çŠ¶æ€ç®¡ç† ====================
    const USER_STATUS = {
        NORMAL: 0,      // æ­£å¸¸
        FROZEN: 1,      // å†»ç»“ï¼ˆä¿¡ç”¨<500ï¼‰
        BLACKLIST: 2    // é»‘åå•ï¼ˆä¿¡ç”¨<400ï¼‰
    };

    const VEHICLE_TYPE = {
        BICYCLE: 1,     // è‡ªè¡Œè½¦
        EBike: 2,       // ç”µåŠ¨è½¦
        CAR: 3          // å°æ±½è½¦
    };

    const VEHICLE_STATUS = {
        NORMAL: 0,      // æ­£å¸¸
        FAULT: 1,       // æ•…éšœ
        REPAIR: 2,      // ç»´ä¿®ä¸­
        SCRAP: 3        // æŠ¥åºŸ
    };

    const ORDER_STATUS = {
        RESERVED: 0,    // é¢„çº¦
        RIDING: 1,      // éª‘è¡Œä¸­
        RETURNED: 2,    // å·²è¿˜è½¦
        PAID: 3,        // å·²æ”¯ä»˜
        COMPLETED: 4    // å·²å®Œæˆ
    };

    const VIOLATION_TYPE = {
        ILLEGAL_PARK: 1,    // è¿åœ
        DAMAGE: 2,          // ç ´å
        PRIVATE_OCCUPY: 3   // ç§å 
    };

    const DEPOSIT_STATUS = {
        UNPAID: 0,      // æœªç¼´
        PAID: 1,        // å·²ç¼´
        REFUNDED: 2     // å·²é€€
    };
    const AppState = {
        user: {
            userId: null, phone: null, creditScore: 600,
            depositStatus: DEPOSIT_STATUS.UNPAID, status: USER_STATUS.NORMAL
        },
        currentVehicle: null, currentOrder: null,
        ridingStartTime: null, ridingTimer: null,
        smsCode: '', countdownTimer: null,
        map: null, markers: []
    };

    // ==================== é¡µé¢è·¯ç”±ç®¡ç†å™¨ ====================
    const PageManager = {
        show(pageId) {
            console.log('ğŸ”„ é¡µé¢è·³è½¬:', pageId);

            // å¼ºåˆ¶æ¸…ç†æ‰€æœ‰é¡µé¢çŠ¶æ€
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });

            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                targetPage.style.display = 'block';
                console.log('âœ… æˆåŠŸæ˜¾ç¤ºé¡µé¢:', pageId);

                // å¦‚æœæ˜¯åœ°å›¾é¡µï¼Œåˆå§‹åŒ–çœŸå®åœ°å›¾
                if (pageId === 'mapPage' && !window.map) {
                    setTimeout(() => {
                        if (document.getElementById('leaflet-map')) {  // ç¡®ä¿DOMå·²æ¸²æŸ“
                            initRealMap();
                        }
                    }, 100);
                }
            } else {
                console.error('âŒ é¡µé¢æœªæ‰¾åˆ°:', pageId);
            }
        },
        showScanModal() {
            document.getElementById('scanModal').classList.add('active');
            setTimeout(() => {
                this.simulateScan();
            }, 2000);
        },
        hideScanModal() {
            document.getElementById('scanModal').classList.remove('active');
        },
        showLoading() {
            document.getElementById('loading').classList.add('active');
        },
        hideLoading() {
            document.getElementById('loading').classList.remove('active');
        },
        showToast(msg, duration = 2000) {
            console.log('ğŸ’¬ Toast:', msg);
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        },
        simulateScan() {
            const mockVehicle = {
                id: 'E002',
                type: VEHICLE_TYPE.EBike,
                battery: 85,
                location: { lat: 39.9, lng: 116.4 }
            };

            setTimeout(() => {
                this.hideScanModal();
                this.showToast('æ‰«ææˆåŠŸï¼');
                setTimeout(() => {
                    PageManager.unlockVehicle(mockVehicle)
                }, 1000);
            }, 2000);
        },

        async unlockVehicle(vehicle) {

            console.log('ğŸ”“ å¼€å§‹å¼€é”æµç¨‹ï¼Œè½¦è¾†:', vehicle);
            AppState.currentVehicle = vehicle;
            // 1. ç”¨æˆ·çŠ¶æ€æ ¡éªŒ
            if (AppState.user.status === USER_STATUS.BLACKLIST) {
                PageManager.showToast('è´¦å·å·²è¢«åˆ—å…¥é»‘åå•ï¼Œæ— æ³•ç”¨è½¦');
                return;
            }
            if (AppState.user.status === USER_STATUS.FROZEN) {
                PageManager.showToast('è´¦å·å·²è¢«å†»ç»“ï¼Œä¿¡ç”¨åˆ†éœ€â‰¥500');
                return;
            }

            // 2. ä¿¡ç”¨åˆ†é—¨æ§›æ ¡éªŒï¼ˆå³æ—¶ç”¨è½¦éœ€â‰¥500ï¼‰
            if (!AppState.user || AppState.user.creditScore < 500) {
                PageManager.showToast(`ä¿¡ç”¨åˆ†${AppState.user?.creditScore}ï¼Œéœ€â‰¥500æ‰èƒ½ç”¨è½¦`);
                return;
            }

            // 3. æŠ¼é‡‘æ£€æŸ¥
            const depositCheck = DepositManager.checkDepositStatus(AppState.user, vehicle);
            if (!depositCheck.canUnlock && depositCheck.requiredAmount) {
                DepositManager.showDepositPage(depositCheck.requiredAmount, vehicle);
                return;
            }

            // 4. ç”µé‡æ£€æŸ¥ï¼ˆå¿…é¡»â‰¥20%ï¼‰
            if (vehicle.battery < 20) {
                PageManager.showToast('è½¦è¾†ç”µé‡ä¸è¶³20%ï¼Œè¯·é€‰æ‹©å…¶ä»–è½¦è¾†');
                return;
            }

            // 5. é¢„çº¦å ç”¨æ£€æŸ¥
            if (vehicle.status === VEHICLE_STATUS.RESERVED) {
                PageManager.showToast('è¯¥è½¦å·²è¢«å…¶ä»–ç”¨æˆ·é¢„çº¦');
                return;
            }

            // 6. IoTå¼€é”æŒ‡ä»¤ä¸‹å‘ï¼ˆ30ç§’è¶…æ—¶ï¼‰
            PageManager.showLoading();
            try {
                // æ¨¡æ‹ŸIoTé€šä¿¡ï¼ˆå®é™…éœ€è°ƒç”¨çœŸå®APIï¼‰
                await IoTService.sendUnlockCommand(vehicle.id);

                // 7. åˆ›å»ºè®¢å•ï¼ˆorderIDæ ¼å¼ä¸ºå¹´æœˆæ—¥æ—¶åˆ†ç§’+6ä½éšæœºï¼‰
                AppState.currentOrder = {
                    orderId: generateOrderId(),
                    userId: AppState.user.userId,
                    vehicleId: vehicle.id,
                    startTime: new Date(),
                    status: ORDER_STATUS.RIDING,
                    vehicleType: vehicle.type
                };

                // 8. å¼€å§‹è½¨è¿¹ä¸ŠæŠ¥
                TrajectoryService.startReporting(AppState.currentOrder.orderId);

                PageManager.hideLoading();
                AppState.ridingStartTime = new Date();
                PageManager.show('ridingPage');
                setTimeout(() => startRidingTimer(), 300);

            } catch (error) {
                PageManager.hideLoading();
                PageManager.showToast('å¼€é”å¤±è´¥ï¼š' + error.message);
                // å¤±è´¥è‡ªåŠ¨é€€æ¬¾
                PaymentService.refundDeposit();
            }
        }
    };
    // ==================== éªŒè¯ç ç®¡ç†å™¨ ====================
    const SMSManager = {
        sendCode(phone) {
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            AppState.smsCode = code;
            console.log(`ğŸ“± éªŒè¯ç å·²ç”Ÿæˆ: ${code}`);
            return code;
        },
        verifyCode(inputCode) {
            const result = inputCode === AppState.smsCode;
            console.log('éªŒè¯ç éªŒè¯:', {
                è¾“å…¥: inputCode,
                ç³»ç»Ÿ: AppState.smsCode,
                ç»“æœ: result ? 'é€šè¿‡' : 'å¤±è´¥'
            });
            return result;
        },
        saveCountdownState(phone, startTime) {
            const key = `sms_countdown_${phone}`;
            localStorage.setItem(key, startTime.toString());
        },
        restoreCountdownState(phone) {
            const key = `sms_countdown_${phone}`;
            const startTime = localStorage.getItem(key);

            if (startTime) {
                const elapsed = Math.floor((Date.now() - parseInt(startTime)) / 1000);
                const remaining = 60 - elapsed;

                return remaining > 0 ? remaining : 0;
            }
            return 0;
        },
        clearCountdownState(phone) {
            const key = `sms_countdown_${phone}`;
            localStorage.removeItem(key);
        }
    };
    // ==================== æŠ¼é‡‘ç®¡ç†å™¨ ====================
    const DepositManager = {
        // è®¡ç®—æ‰€éœ€æŠ¼é‡‘
        calculateDeposit(vehicleType, creditScore) {
            if (creditScore >= 650) {
                return { required: false, amount: 0 }; // å…æŠ¼
            }

            const amounts = {
                [VEHICLE_TYPE.BICYCLE]: 29,
                [VEHICLE_TYPE.EBike]: 99,
                [VEHICLE_TYPE.CAR]: 199
            };

            return {
                required: true,
                amount: amounts[vehicleType] || 0
            };
        },

        // æ£€æŸ¥æŠ¼é‡‘çŠ¶æ€
        checkDepositStatus(user, vehicle) {
            const deposit = this.calculateDeposit(vehicle.type, user.creditScore);

            if (!deposit.required) {
                return { canUnlock: true, message: 'å·²å…æŠ¼é‡‘' };
            }

            if (user.depositStatus === DEPOSIT_STATUS.PAID) {
                return { canUnlock: true, message: 'æŠ¼é‡‘å·²ç¼´' };
            }

            return {
                canUnlock: false,
                message: `éœ€ç¼´çº³æŠ¼é‡‘Â¥${deposit.amount}`,
                requiredAmount: deposit.amount
            };
        },

        // æ˜¾ç¤ºæŠ¼é‡‘æ”¯ä»˜é¡µé¢
        showDepositPage(amount, vehicle) {
            const modal = document.createElement('div');
            modal.id = 'depositModal';
            modal.innerHTML = `
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:5000;display:flex;align-items:center;justify-content:center;">
            <div style="background:white;padding:32px;border-radius:12px;width:90%;max-width:300px;">
                <h3 style="margin-bottom:20px;">ç¼´çº³æŠ¼é‡‘</h3>
                <p style="color:#666;margin-bottom:24px;">æ‚¨éœ€è¦ç¼´çº³æŠ¼é‡‘ Â¥${amount}</p>
                <button id="payDepositBtn" class="btn-primary">ç«‹å³æ”¯ä»˜</button> <!-- âœ… æ·»åŠ ID -->
                <button class="btn-secondary" style="margin-top:12px;" onclick="document.getElementById('depositModal').remove()">å–æ¶ˆ</button>
            </div>
        </div>
    `;

            document.body.appendChild(modal);

            modal.querySelector('#payDepositBtn').addEventListener('click', function() {
                DepositManager.payDeposit(amount, this, vehicle);
            });
        },

        // æ¨¡æ‹Ÿæ”¯ä»˜æŠ¼é‡‘
        payDeposit(amount, btn, vehicle) {
            btn.disabled = true;
            btn.textContent = 'æ”¯ä»˜ä¸­...';

            setTimeout(() => {
                AppState.user.depositStatus = DEPOSIT_STATUS.PAID;

                const modal = document.getElementById('depositModal');
                if (modal) modal.remove();

                PageManager.showToast('æŠ¼é‡‘æ”¯ä»˜æˆåŠŸï¼');

                this.completeUnlockAfterDeposit(vehicle);
            }, 1500);
        },
        completeUnlockAfterDeposit(vehicle) {
            PageManager.showLoading();

            try {
                AppState.currentVehicle = vehicle;
                // ç›´æ¥åˆ›å»ºè®¢å•
                AppState.currentOrder = {
                    orderId: generateOrderId(),
                    userId: AppState.user.userId,
                    vehicleId: vehicle.id,
                    startTime: new Date(),
                    status: ORDER_STATUS.RIDING,
                    vehicleType: vehicle.type
                };

                // å¯åŠ¨è½¨è¿¹ä¸ŠæŠ¥
                TrajectoryService.startReporting(AppState.currentOrder.orderId);

                PageManager.hideLoading();
                AppState.ridingStartTime = new Date();

                // âœ… ç›´æ¥æ˜¾ç¤ºéª‘è¡Œé¡µ
                PageManager.show('ridingPage');
                setTimeout(() => startRidingTimer(), 300);

            } catch (error) {
                PageManager.hideLoading();
                PageManager.showToast('å¼€é”å¤±è´¥ï¼š' + error.message);
            }
        }
    };

    // ==================== è®¡è´¹å¼•æ“ ====================
    const BillingService = {
        // è‡ªè¡Œè½¦è®¡è´¹ï¼ˆ0.5å…ƒ/30minï¼Œä¸è¶³æŒ‰30minï¼Œè¶…1hå1å…ƒ/30minï¼‰
        calculateBikeFee(minutes) {
            if (minutes <= 30) return 0.5;

            const baseFee = 0.5;
            const extraMinutes = Math.max(0, minutes - 60);
            const extraFee = Math.ceil(extraMinutes / 30) * 1;

            return parseFloat((baseFee + extraFee).toFixed(2));
        },

        // ç”µåŠ¨è½¦è®¡è´¹ï¼ˆ1å…ƒ/10min + 0.3å…ƒ/kmï¼‰
        calculateEbikeFee(minutes, distance) {
            const timeFee = Math.ceil(minutes / 10) * 1;
            const distanceFee = Math.ceil(distance / 0.3) * 0.3; // ä¸è¶³0.3kmæŒ‰0.3km
            return parseFloat((timeFee + distanceFee).toFixed(2));
        },

        // å°æ±½è½¦è®¡è´¹ï¼ˆ0.8å…ƒ/min + 1.2å…ƒ/km + å¼‚åœ°è¿˜è½¦è´¹ï¼‰
        calculateCarFee(minutes, distance, returnLocation) {
            const timeFee = minutes * 0.8;
            const distanceFee = distance * 1.2;
            let remoteFee = 0;

            // å¼‚åœ°è¿˜è½¦è´¹è®¡ç®—ï¼ˆç®€åŒ–ä¸ºæ˜¯å¦è·¨åŒºï¼‰
            if (returnLocation && returnLocation.isRemote) {
                remoteFee = 10; // åŸºç¡€å¼‚åœ°è´¹
                // è¶…å‡º20kméƒ¨åˆ†ï¼š3å…ƒ/km
                if (distance > 20) {
                    remoteFee += (distance - 20) * 3;
                }
            }

            return parseFloat((timeFee + distanceFee + remoteFee).toFixed(2));
        },

        // ä¸»è®¡è´¹å…¥å£
        calculateOrderFee(order) {
            const duration = (order.endTime - order.startTime) / 1000 / 60; // åˆ†é’Ÿ
            const distance = order.distance || 0; // å…¬é‡Œ

            switch(order.vehicleType) {
                case VEHICLE_TYPE.BICYCLE:
                    return this.calculateBikeFee(duration);
                case VEHICLE_TYPE.EBike:
                    return this.calculateEbikeFee(duration, distance);
                case VEHICLE_TYPE.CAR:
                    return this.calculateCarFee(duration, distance, order.returnLocation);
                default:
                    return 0;
            }
        }
    };

    // ==================== ä¿¡ç”¨åˆ†æœåŠ¡ ====================
    const CreditService = {
        // æ›´æ–°ä¿¡ç”¨åˆ†
        updateScore(userId, delta, reason) {
            AppState.user.creditScore += delta;

            // ç¡®ä¿èŒƒå›´åœ¨300-900
            AppState.user.creditScore = Math.max(300, Math.min(900, AppState.user.creditScore));

            // çŠ¶æ€å˜æ›´æ£€æŸ¥
            if (AppState.user.creditScore < 400) {
                this.blacklistUser(userId);
            } else if (AppState.user.creditScore < 500) {
                this.freezeUser(userId);
            }

            // è®°å½•å˜åŠ¨æ—¥å¿—
            this.logScoreChange(userId, delta, reason);

            // æ¨é€é€šçŸ¥
            PageManager.showToast(`ä¿¡ç”¨åˆ†${delta > 0 ? '+' : ''}${delta}ï¼Œå½“å‰${AppState.user.creditScore}`);
        },

        // å†»ç»“è´¦å·
        freezeUser(userId) {
            AppState.user.status = USER_STATUS.FROZEN;
            PageManager.showToast('è´¦å·å·²å†»ç»“ï¼Œä¿¡ç”¨åˆ†éœ€æ¢å¤è‡³500ä»¥ä¸Š');
        },

        // åˆ—å…¥é»‘åå•ï¼ˆåŒæ­¥æ”¿åºœå¹³å°ï¼‰
        blacklistUser(userId) {
            AppState.user.status = USER_STATUS.BLACKLIST;
            // å®é™…åº”è°ƒç”¨åç«¯æ¥å£åŒæ­¥è‡³äº¤é€šå±€
            console.warn('ç”¨æˆ·åˆ—å…¥é»‘åå•ï¼Œéœ€åŒæ­¥è‡³æ”¿åºœå¹³å°');
            PageManager.showToast('ä¿¡ç”¨åˆ†è¿‡ä½ï¼Œå·²åˆ—å…¥é»‘åå•å¹¶åŒæ­¥æ”¿åºœç³»ç»Ÿ');
        },

        // è®°å½•ä¿¡ç”¨åˆ†å˜åŠ¨
        logScoreChange(userId, delta, reason) {
            const log = {
                userId,
                delta,
                newScore: AppState.user.creditScore,
                reason,
                timestamp: new Date()
            };
            // å‘é€è‡³åç«¯
            console.log('ä¿¡ç”¨åˆ†å˜åŠ¨:', log);
        }
    };


    // ==================== ç”¨æˆ·ç›¸å…³åŠŸèƒ½ ====================
    function login() {
        const phone = document.getElementById('phoneInput').value.trim();
        const code = document.getElementById('codeInput').value.trim();

        if (!phone || phone.length !== 11) {
            PageManager.showToast('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·');
            return;
        }

        if (!code) {
            PageManager.showToast('è¯·è¾“å…¥éªŒè¯ç ');
            return;
        }

        if (!SMSManager.verifyCode(code)) {
            PageManager.showToast(`éªŒè¯ç é”™è¯¯ï¼æ­£ç¡®éªŒè¯ç æ˜¯: ${AppState.smsCode}`, 3000);
            document.getElementById('codeInput').value = '';
            return;
        }

        PageManager.showLoading();
        setTimeout(() => {
            AppState.user = { phone, userId: 'U001' };
            AppState.isLoggedIn = true;

            // æ¸…ç†çŠ¶æ€
            AppState.smsCode = '';
            if (AppState.countdownTimer) {
                clearInterval(AppState.countdownTimer);
            }
            SMSManager.clearCountdownState(phone);

            PageManager.hideLoading();

            // æ¸…ç†ç™»å½•é¡µè¡¨å•
            document.getElementById('phoneInput').value = '';
            document.getElementById('codeInput').value = '';
            document.getElementById('getCodeBtn').disabled = false;
            document.getElementById('getCodeBtn').textContent = 'è·å–éªŒè¯ç ';

            if (!localStorage.getItem('isAuthenticated')) {
                PageManager.show('authPage');
            } else {
                PageManager.show('mapPage');
            }
        }, 1000);
    }

    function wechatLogin() {
        PageManager.showLoading();
        setTimeout(() => {
            AppState.user = { userId: 'U001', openid: 'wx123' };
            AppState.isLoggedIn = true;

            if (!localStorage.getItem('isAuthenticated')) {
                PageManager.hideLoading();
                PageManager.show('authPage');
            } else {
                PageManager.hideLoading();
                PageManager.show('mapPage');
            }
        }, 1000);
    }

    function logout() {
        if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
            AppState.user = null;
            AppState.isLoggedIn = false;
            localStorage.removeItem('isAuthenticated');
            SMSManager.clearCountdownState(document.getElementById('phoneInput').value);
            PageManager.show('loginPage');
        }
    }

    // ==================== åœ°å›¾ç›¸å…³åŠŸèƒ½ ====================
    function initRealMap() {
        if (window.map) return;

        // åˆå§‹åŒ–Leafletåœ°å›¾
        window.map = L.map('leaflet-map').setView([39.9042, 116.4074], 13); // åŒ—äº¬å¤©å®‰é—¨

        // æ·»åŠ OpenStreetMapç“¦ç‰‡å±‚
        L.tileLayer('https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            attribution: 'Â© é«˜å¾·åœ°å›¾',
            maxZoom: 18
        }).addTo(window.map);

        // åŠ è½½ç”µå­å›´æ ï¼ˆGeoJSONæ ¼å¼ï¼‰
        loadElectronicFences();

        // æ·»åŠ è½¦è¾†æ ‡è®°
        addVehicleMarkers();

        console.log('âœ… Leafletåœ°å›¾åˆå§‹åŒ–å®Œæˆ');
    }
    function addVehicleMarkers() {
        const vehicles = [
            // è‡ªè¡Œè½¦ (ç»¿è‰²)
            { id: 'B001', type: VEHICLE_TYPE.BICYCLE, lng: 116.4074, lat: 39.9042, battery: 100, status: VEHICLE_STATUS.NORMAL },
            { id: 'B002', type: VEHICLE_TYPE.BICYCLE, lng: 116.4100, lat: 39.9100, battery: 85, status: VEHICLE_STATUS.NORMAL },
            { id: 'B003', type: VEHICLE_TYPE.BICYCLE, lng: 116.4050, lat: 39.8980, battery: 92, status: VEHICLE_STATUS.NORMAL },
            { id: 'B004', type: VEHICLE_TYPE.BICYCLE, lng: 116.4200, lat: 39.9080, battery: 78, status: VEHICLE_STATUS.NORMAL },
            { id: 'B005', type: VEHICLE_TYPE.BICYCLE, lng: 116.3950, lat: 39.9000, battery: 65, status: VEHICLE_STATUS.NORMAL },
            { id: 'B006', type: VEHICLE_TYPE.BICYCLE, lng: 116.4300, lat: 39.8950, battery: 88, status: VEHICLE_STATUS.NORMAL },

            // ç”µåŠ¨è½¦ (é»„è‰²)
            { id: 'E002', type: VEHICLE_TYPE.EBike, lng: 116.4174, lat: 39.9142, battery: 85, status: VEHICLE_STATUS.NORMAL },
            { id: 'E003', type: VEHICLE_TYPE.EBike, lng: 116.4250, lat: 39.9050, battery: 72, status: VEHICLE_STATUS.NORMAL },
            { id: 'E004', type: VEHICLE_TYPE.EBike, lng: 116.4150, lat: 39.9200, battery: 60, status: VEHICLE_STATUS.NORMAL },
            { id: 'E005', type: VEHICLE_TYPE.EBike, lng: 116.4080, lat: 39.8900, battery: 95, status: VEHICLE_STATUS.NORMAL },
            { id: 'E006', type: VEHICLE_TYPE.EBike, lng: 116.4350, lat: 39.9120, battery: 45, status: VEHICLE_STATUS.LOW_BATTERY },

            // å°æ±½è½¦ (çº¢è‰²)
            { id: 'C003', type: VEHICLE_TYPE.CAR, lng: 116.3974, lat: 39.8942, battery: 90, status: VEHICLE_STATUS.NORMAL },
            { id: 'C004', type: VEHICLE_TYPE.CAR, lng: 116.4180, lat: 39.9180, battery: 85, status: VEHICLE_STATUS.NORMAL },
            { id: 'C005', type: VEHICLE_TYPE.CAR, lng: 116.4050, lat: 39.8850, battery: 78, status: VEHICLE_STATUS.NORMAL },
            { id: 'C006', type: VEHICLE_TYPE.CAR, lng: 116.4280, lat: 39.9020, battery: 92, status: VEHICLE_STATUS.NORMAL }
        ];

        vehicles.forEach(vehicle => {
            // åˆ›å»ºè‡ªå®šä¹‰å›¾æ ‡
            const iconColor = vehicle.type === VEHICLE_TYPE.BICYCLE ? '#52c41a'
                : vehicle.type === VEHICLE_TYPE.EBike ? '#faad14'
                    : '#f5222d';

            // çŠ¶æ€æ ‡è®°
            const statusText = vehicle.status === VEHICLE_STATUS.LOW_BATTERY ? 'ç”µé‡ä¸è¶³' : 'å¯ç§Ÿç”¨';

            const icon = L.divIcon({
                html: `<div style="background:${iconColor};width:36px;height:36px;border-radius:50%;border:3px solid white;box-shadow:0 3px 12px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:13px;">${vehicle.battery}%</div>`,
                className: 'custom-marker',
                iconSize: [42, 42],      // âœ… å¢å¤§å®¹å™¨
                iconAnchor: [21, 21]
            });

            const marker = L.marker([vehicle.lat, vehicle.lng], { icon })
                .addTo(window.map)
                .bindPopup(`<b>è½¦è¾†${vehicle.id}</b><br>ç”µé‡: ${vehicle.battery}%`);

            marker.on('click', () => selectVehicle(vehicle.id));
        });
    }
    function locateMe() {
        PageManager.showToast('æ­£åœ¨å®šä½...');

        if (!navigator.geolocation) {
            PageManager.showToast('æµè§ˆå™¨ä¸æ”¯æŒå®šä½');
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                // è®¾ç½®åœ°å›¾ä¸­å¿ƒ
                window.map.setView([lat, lng], 16);

                // æ·»åŠ å®šä½æ ‡è®°
                L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: '<div style="background:#4A90E2;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
                        className: 'location-marker',
                        iconSize: [26, 26],
                        iconAnchor: [13, 13]
                    })
                }).addTo(window.map)
                    .bindPopup('å½“å‰ä½ç½®')
                    .openPopup();

                PageManager.showToast('å®šä½æˆåŠŸ');
            },
            (error) => {
                PageManager.showToast('å®šä½å¤±è´¥ï¼š' + error.message);
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    function selectVehicle(vehicleId) {
        const vehicles = {
            'B001': { type: 'è‡ªè¡Œè½¦', battery: 100, fee: '0.5å…ƒ/30åˆ†é’Ÿ' },
            'E002': { type: 'ç”µåŠ¨è½¦', battery: 85, fee: '1å…ƒ/10åˆ†é’Ÿ+0.3å…ƒ/km' },
            'C003': { type: 'å°æ±½è½¦', battery: 90, fee: '0.8å…ƒ/åˆ†é’Ÿ+1.2å…ƒ/km' }
        };

        const vehicle = vehicles[vehicleId];
        if (vehicle) {
            AppState.currentVehicle = { id: vehicleId, ...vehicle };
            if (confirm(`é€‰æ‹©${vehicle.type}ï¼Ÿ\nè´¹ç”¨ï¼š${vehicle.fee}\nç”µé‡ï¼š${vehicle.battery}%`)) {
                PageManager.unlockVehicle(vehicle);
            }
        }
    }


    // ==================== è½¦è¾†è§£é”åŠŸèƒ½ ====================
    function openScan() {
        PageManager.showScanModal();
    }

    function closeScan() {
        PageManager.hideScanModal();
    }

    function tempLock() {
        PageManager.showToast('ä¸´æ—¶é”è½¦æˆåŠŸï¼Œç»§ç»­è®¡è´¹');
    }

    async function finishRide() {
        if (!confirm('ç¡®å®šè¦ç»“æŸéª‘è¡Œå—ï¼Ÿ')) return;

        // âœ… é˜²å¾¡æ€§æ£€æŸ¥
        if (!AppState.currentVehicle) {
            console.error('âŒ currentVehicle ä¸ºç©º');
            PageManager.showToast('è½¦è¾†çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡è¯•');
            return;
        }
        PageManager.showLoading();

        try {
            const vehicleId = AppState.currentVehicle.id;
            // 1. æ£€æŸ¥ç”µå­å›´æ ï¼ˆGPS+åŒ—æ–—è¯¯å·®â‰¤10mï¼‰
            const currentPos = await getCurrentPosition();
            const inFence = await GeoService.checkElectronicFence(currentPos.lat, currentPos.lng);

            if (!inFence) {
                // é¦–æ¬¡è­¦å‘Šï¼ŒäºŒæ¬¡èµ·åŠ æ”¶è°ƒåº¦è´¹
                const violationCount = getUserViolationCount(AppState.user.userId);
                const dispatchFee = violationCount === 0 ? 0 : 10;

                if (dispatchFee > 0) {
                    DepositManager.showDepositPage(dispatchFee, () => {
                        PageManager.unlockVehicle(AppState.currentVehicle);
                    });
                    return;
                } else {
                    PageManager.showToast('æœªåœ¨è§„èŒƒåœæ”¾ç‚¹ï¼Œé¦–æ¬¡è­¦å‘Š');
                }

                // åˆ›å»ºè¿åœè®°å½•
                ViolationService.createViolation({
                    orderId: AppState.currentOrder.orderId,
                    userId: AppState.user.userId,
                    vioType: VIOLATION_TYPE.ILLEGAL_PARK,
                    penalty: dispatchFee,
                    creditDelta: -20
                });

                // ä¿¡ç”¨åˆ†æ‰£å‡
                CreditService.updateScore(AppState.user.userId, -20, 'è¿åœ');
            }

            // 2. è®¡ç®—æœ€ç»ˆè´¹ç”¨
            AppState.currentOrder.endTime = new Date();
            AppState.currentOrder.distance = calculateRidingDistance();
            const finalFee = BillingService.calculateOrderFee(AppState.currentOrder);
            AppState.currentOrder.fee = finalFee;

            // 3. è½¦è¾†çŠ¶æ€é‡ç½®
            VehicleService.updateStatus(vehicleId, VEHICLE_STATUS.NORMAL);

            // 4. åœæ­¢è®¡è´¹ä¸è½¨è¿¹ä¸ŠæŠ¥
            clearInterval(AppState.ridingTimer);
            TrajectoryService.stopReporting();

            PageManager.hideLoading();

            // 5. æ˜¾ç¤ºè´¦å•
            showPaymentPage(AppState.currentOrder);

        } catch (error) {
            PageManager.hideLoading();
            PageManager.showToast('è¿˜è½¦å¤±è´¥ï¼š' + error.message);
        }
    }
    function goToDeposit() {
        const status = AppState.user.depositStatus;
        if (status === DEPOSIT_STATUS.PAID) {
            PageManager.showToast('æŠ¼é‡‘å·²ç¼´çº³');
        } else if (status === DEPOSIT_STATUS.REFUNDED) {
            PageManager.showToast('æŠ¼é‡‘å·²é€€è¿˜');
        } else {
            PageManager.showToast('æ‚¨å½“å‰æ— éœ€ç¼´çº³æŠ¼é‡‘ï¼ˆä¿¡ç”¨åˆ†â‰¥650ï¼‰');
        }
    }
    // æ˜¾ç¤ºæ”¯ä»˜é¡µé¢
    function showPaymentPage(order) {
        const modal = document.createElement('div');
        modal.id = 'paymentModal';
        modal.innerHTML = `
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:5000;display:flex;align-items:center;justify-content:center;">
            <div style="background:white;padding:32px;border-radius:12px;width:90%;max-width:320px;">
                <h3 style="margin-bottom:20px;">è¡Œç¨‹ç»“æŸ</h3>
                <div style="margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span>æ—¶é•¿è´¹</span><span>Â¥${order.fee}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;color:#999;font-size:14px;">
                        <span>ç”¨æ—¶${Math.floor((order.endTime - order.startTime)/60000)}åˆ†é’Ÿ</span>
                        <span>è·ç¦»${order.distance || 0}km</span>
                    </div>
                </div>
                <button class="btn-primary" onclick="PaymentService.payOrder('${order.orderId}')">ç«‹å³æ”¯ä»˜</button>
                <button class="btn-secondary" style="margin-top:12px;" onclick="this.closest('div').remove()">å–æ¶ˆ</button>
            </div>
        </div>
    `;
        document.body.appendChild(modal);
    }

    // ==================== éª‘è¡Œè®¡æ—¶å™¨ ====================
    function startRidingTimer() {
        AppState.ridingTimer = setInterval(() => {
            const now = new Date();
            const elapsed = Math.floor((now - AppState.ridingStartTime) / 1000);

            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('ridingTime').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            const fee = (minutes * 0.1 + Math.random() * 0.5).toFixed(2);
            document.getElementById('ridingFee').textContent = `Â¥${fee}`;
        }, 1000);
    }

    // ==================== å®åè®¤è¯åŠŸèƒ½ ====================
    function uploadIdCard() {
        PageManager.showToast('è¯·é€‰æ‹©èº«ä»½è¯ç…§ç‰‡');
        setTimeout(() => {
            PageManager.showToast('OCRè¯†åˆ«æˆåŠŸ');
        }, 2000);
    }

    function startFaceVerify() {
        console.log('ğŸ” ç‚¹å‡»äº†äººè„¸è¯†åˆ«æŒ‰é’®');

        const btn = document.querySelector('#authPage .btn-primary');
        if (btn.disabled) return;
        btn.disabled = true;

        PageManager.showToast('æ­£åœ¨å¯åŠ¨äººè„¸è¯†åˆ«...');
        console.log('æ­¥éª¤1ï¼šå¯åŠ¨äººè„¸è¯†åˆ«æç¤ºå·²æ˜¾ç¤º');

        setTimeout(() => {
            PageManager.showToast('çœŸäººæ£€æµ‹æˆåŠŸï¼Œæ­£åœ¨æ¯”å¯¹å…¬å®‰åº“...');
            console.log('æ­¥éª¤2ï¼šæ´»ä½“æ£€æµ‹å®Œæˆï¼Œè¿›å…¥å…¬å®‰åº“æ¯”å¯¹');

            setTimeout(() => {
                console.log('æ­¥éª¤3ï¼šå…¬å®‰åº“æ¯”å¯¹å®Œæˆ');

                localStorage.setItem('isAuthenticated', 'true');
                AppState.creditScore = 650;
                console.log('âœ… å®åè®¤è¯çŠ¶æ€å·²ä¿å­˜åˆ° localStorage');

                PageManager.showToast('å®åè®¤è¯æˆåŠŸï¼1ç§’åè·³è½¬åˆ°é¦–é¡µ');
                console.log('æ­¥éª¤4ï¼šæ˜¾ç¤ºæˆåŠŸæç¤ºï¼Œå‡†å¤‡è·³è½¬');

                setTimeout(() => {
                    btn.disabled = false;
                    PageManager.show('mapPage');
                    PageManager.showToast('æ¬¢è¿å¼€å§‹æ‚¨çš„å…±äº«å‡ºè¡Œï¼');
                    console.log('ğŸ‰ å·²è·³è½¬åˆ°åœ°å›¾é¦–é¡µ');
                }, 1000);

            }, 2000);
        }, 1000);
    }

    // ==================== å¯¼èˆªåŠŸèƒ½ ====================
    function goToProfile() {
        PageManager.show('profilePage');
        document.getElementById('creditScore').textContent = AppState.creditScore;
    }

    function backToMap() {
        PageManager.show('mapPage');
    }

    function goToOrders() {
        PageManager.showToast('æˆ‘çš„è¡Œç¨‹åŠŸèƒ½å¼€å‘ä¸­');
    }

    function goToCoupons() {
        PageManager.showToast('ä¼˜æƒ åˆ¸åŠŸèƒ½å¼€å‘ä¸­');
    }

    function goToWallet() {
        PageManager.showToast('é’±åŒ…åŠŸèƒ½å¼€å‘ä¸­');
    }

    function goToCredit() {
        PageManager.showToast('ä¿¡ç”¨åˆ†åŠŸèƒ½å¼€å‘ä¸­');
    }

    // ==================== å€’è®¡æ—¶å‡½æ•° ====================
    function startCountdown(seconds) {
        const btn = document.getElementById('getCodeBtn');
        if (!btn) return;

        let count = seconds;
        if (AppState.countdownTimer) {
            clearInterval(AppState.countdownTimer);
        }

        btn.disabled = true;
        btn.textContent = `${count}ç§’åé‡è¯•`;

        AppState.countdownTimer = setInterval(() => {
            count--;
            btn.textContent = `${count}ç§’åé‡è¯•`;

            if (count <= 0) {
                clearInterval(AppState.countdownTimer);
                btn.disabled = false;
                btn.textContent = 'è·å–éªŒè¯ç ';

                const phone = document.getElementById('phoneInput')?.value;
                if (phone) {
                    SMSManager.clearCountdownState(phone);
                }
            }
        }, 1000);
    }

    // ==================== IoTè®¾å¤‡é€šä¿¡æœåŠ¡ ====================
    const IoTService = {
        // å‘é€å¼€é”æŒ‡ä»¤ï¼ˆæ–‡æ¡£ï¼š30ç§’è¶…æ—¶ï¼‰
        async sendUnlockCommand(vehicleId) {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('å¼€é”è¶…æ—¶ï¼ˆ30ç§’ï¼‰'));
                }, 30000);

                // æ¨¡æ‹ŸMQTT/NB-IoTé€šä¿¡
                setTimeout(() => {
                    clearTimeout(timeout);
                    const success = Math.random() > 0.1; // 90%æˆåŠŸç‡
                    if (success) {
                        resolve(true);
                    } else {
                        reject(new Error('è½¦è¾†æ— å“åº”'));
                    }
                }, 2000 + Math.random() * 3000);
            });
        },

        // å‘é€é”è½¦æŒ‡ä»¤
        async sendLockCommand(vehicleId) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve(true);
                }, 1000);
            });
        }
    };

    // ==================== æ¨¡æ‹ŸæœåŠ¡æ¡©ï¼ˆStubï¼‰====================
    // ç”µå­å›´æ æœåŠ¡
    function loadElectronicFences() {
        if (!window.map) return;

        // æ¨¡æ‹Ÿç”µå­å›´æ æ•°æ®ï¼ˆGeoJSONæ ¼å¼ï¼‰
        const fenceData = {
            type: "FeatureCollection",
            features: [
                {
                    type: "Feature",
                    properties: { name: "è§„èŒƒåœè½¦åŒºA", type: "allowed" },
                    geometry: {
                        type: "Polygon",
                        coordinates: [[
                            [116.3974, 39.9042],
                            [116.4074, 39.9042],
                            [116.4074, 39.9142],
                            [116.3974, 39.9142],
                            [116.3974, 39.9042]
                        ]]
                    }
                }
            ]
        };

        // åœ¨åœ°å›¾ä¸Šç»˜åˆ¶ç”µå­å›´æ ï¼ˆç»¿è‰²åŒºåŸŸï¼‰
        L.geoJSON(fenceData, {
            style: {
                color: '#52c41a',
                weight: 2,
                opacity: 0.8,
                fillColor: '#52c41a',
                fillOpacity: 0.1
            }
        }).addTo(window.map);

        console.log('âœ… ç”µå­å›´æ åŠ è½½å®Œæˆ');
    }

    // åœ°ç†ä½ç½®æœåŠ¡
    const GeoService = {
        async checkElectronicFence(lat, lng) {
            // æ¨¡æ‹Ÿæ£€æŸ¥ï¼šéšæœºè¿”å›æ˜¯å¦åœ¨å›´æ å†…ï¼ˆ90%æ¦‚ç‡åœ¨èŒƒå›´å†…ï¼‰
            return Math.random() > 0.1;
        }
    };

    // è¿åœè®°å½•æœåŠ¡
    const ViolationService = {
        createViolation(violation) {
            console.log('ğŸš« è¿åœè®°å½•:', violation);
            // æ¨¡æ‹Ÿå­˜å‚¨åˆ°åç«¯
            localStorage.setItem(`violation_${violation.orderId}`, JSON.stringify(violation));
        }
    };

    // æ”¯ä»˜æœåŠ¡
    const PaymentService = {
        async payOrder(orderId) {
            PageManager.showLoading();
            const modal = document.getElementById('paymentModal');
            setTimeout(() => {
                PageManager.hideLoading();
                PageManager.showToast('æ”¯ä»˜æˆåŠŸï¼');
                // æ›´æ–°è®¢å•çŠ¶æ€
                if (AppState.currentOrder) {
                    AppState.currentOrder.status = ORDER_STATUS.PAID;
                }
                if (modal) {
                    modal.remove();
                }
                // âœ… æ¸…ç†éª‘è¡ŒçŠ¶æ€å¹¶è¿”å›åœ°å›¾
                AppState.currentVehicle = null;
                AppState.currentOrder = null;
                AppState.ridingStartTime = null;
                clearInterval(AppState.ridingTimer);
                // è¿”å›åœ°å›¾é¡µ
                setTimeout(() => PageManager.show('mapPage'), 1000);
            }, 1500);
        },

        refundDeposit() {
            console.log('ğŸ’° æŠ¼é‡‘é€€æ¬¾å¤„ç†ä¸­...');
            PageManager.showToast('æŠ¼é‡‘å°†åœ¨3-7ä¸ªå·¥ä½œæ—¥å†…åŸè·¯é€€å›');
        }
    };

    // è½¨è¿¹ä¸ŠæŠ¥æœåŠ¡
    const TrajectoryService = {
        startReporting(orderId) {
            console.log(`ğŸ“ å¼€å§‹ä¸ŠæŠ¥è½¨è¿¹: ${orderId}`);
            // æ¨¡æ‹Ÿæ¯5ç§’ä¸ŠæŠ¥ä¸€æ¬¡GPSä½ç½®
            this.reportInterval = setInterval(() => {
                navigator.geolocation.getCurrentPosition(pos => {
                    console.log(`[${new Date().toISOString()}] ä½ç½®: ${pos.coords.latitude}, ${pos.coords.longitude}`);
                });
            }, 5000);
        },

        stopReporting() {
            if (this.reportInterval) {
                clearInterval(this.reportInterval);
                console.log('ğŸ“ åœæ­¢è½¨è¿¹ä¸ŠæŠ¥');
            }
        }
    };

    // è½¦è¾†æœåŠ¡
    const VehicleService = {
        updateStatus(vehicleId, status) {
            console.log(`ğŸš² è½¦è¾†${vehicleId}çŠ¶æ€æ›´æ–°ä¸º: ${status}`);
        }
    };

    // è·å–ç”¨æˆ·è¿åœæ¬¡æ•°
    function getUserViolationCount(userId) {
        const violations = Object.keys(localStorage).filter(key => key.startsWith('violation_'));
        return violations.length;
    }

    // ==================== å·¥å…·å‡½æ•° ====================
    // ç”Ÿæˆè®¢å•IDï¼ˆæ–‡æ¡£ï¼šå¹´æœˆæ—¥æ—¶åˆ†ç§’+6ä½éšæœºï¼‰
    function generateOrderId() {
        const date = new Date();
        const dateStr = date.getFullYear().toString() +
            String(date.getMonth() + 1).padStart(2, '0') +
            String(date.getDate()).padStart(2, '0') +
            String(date.getHours()).padStart(2, '0') +
            String(date.getMinutes()).padStart(2, '0') +
            String(date.getSeconds()).padStart(2, '0');
        const random = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
        return `ORD${dateStr}${random}`;
    }

    // è·å–å½“å‰ä½ç½®ï¼ˆPromiseå°è£…ï¼‰
    function getCurrentPosition() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('æµè§ˆå™¨ä¸æ”¯æŒå®šä½'));
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => resolve({
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy
                }),
                (error) => reject(error),
                { enableHighAccuracy: true, timeout: 10000 }
            );
        });
    }

    // è®¡ç®—éª‘è¡Œè·ç¦»ï¼ˆæ¨¡æ‹Ÿï¼‰
    function calculateRidingDistance() {
        // å®é™…åº”é€šè¿‡è½¨è¿¹ç‚¹ç´¯åŠ 
        return (Math.random() * 5 + 1).toFixed(1); // æ¨¡æ‹Ÿ1-6km
    }
    // ==================== åˆå§‹åŒ– ====================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ åº”ç”¨åˆå§‹åŒ–å®Œæˆ');

        const phoneInput = document.getElementById('phoneInput');
        const getCodeBtn = document.getElementById('getCodeBtn');
        const codeInput = document.getElementById('codeInput');
        const pages = document.querySelectorAll('.page');

        // æ¸…ç†é¡µé¢çŠ¶æ€
        pages.forEach(page => {
            page.classList.remove('active');
            page.style.display = 'none';
        });

        // æ˜¾ç¤ºç™»å½•é¡µ
        PageManager.show('loginPage');

        // æ‰‹æœºå·è¾“å…¥æ ¼å¼åŒ–
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.slice(0, 11);
                e.target.value = value;
            });

            // ä¿®å¤bluräº‹ä»¶ï¼šä½¿ç”¨å·²å£°æ˜çš„getCodeBtnå˜é‡
            phoneInput.addEventListener('blur', function() {
                const phone = this.value.trim();
                if (phone.length === 11) {
                    const remaining = SMSManager.restoreCountdownState(phone);
                    if (remaining > 0) {
                        startCountdown(remaining);
                        if (getCodeBtn) getCodeBtn.disabled = true; // âœ… ä½¿ç”¨å·²å£°æ˜çš„å˜é‡
                    }
                }
            });
        }

        // éªŒè¯ç æŒ‰é’®äº‹ä»¶
        if (getCodeBtn) {
            getCodeBtn.addEventListener('click', function() {
                const phone = phoneInput.value.trim();
                if (!phone || phone.length !== 11) {
                    PageManager.showToast('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·');
                    return;
                }

                if (this.disabled) return;

                SMSManager.sendCode(phone);
                codeInput.value = AppState.smsCode; // æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨å¡«å……
                SMSManager.saveCountdownState(phone, Date.now());

                PageManager.showToast('éªŒè¯ç å·²å‘é€');
                startCountdown(60);
            });
        }

        // åº•éƒ¨å¯¼èˆªäº‹ä»¶
        document.querySelectorAll('.bottom-nav-item').forEach(item => {
            item.addEventListener('click', function() {
                const target = this.dataset.target;
                if (target === 'map') {
                    PageManager.show('mapPage');
                } else if (target === 'profile') {
                    goToProfile();
                }
                document.querySelectorAll('.bottom-nav-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });
    });


</script>

</body>
</html>